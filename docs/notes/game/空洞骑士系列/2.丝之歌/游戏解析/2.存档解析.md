---
title: 存档解析
createTime: 2026/01/13 15:59:49
permalink: /notes/games/hollow_knight/silk_song/save_parse/
---
          
从 `.dat` 最终得到 JSON，实际走的是一条“二进制 → 提取字符串 → 解密 → JSON.parse”的流水线。你现在这个项目里对应的代码基本都在 [app.js](file:///d:/Projects/TraeProjects/parse/src/app.js)。

**1）把 .dat 读成字节数组**
- 用户选择文件后触发 `datFile` 的 change 事件：[app.js:L251-L285](file:///d:/Projects/TraeProjects/parse/src/app.js#L251-L285)
- `file.arrayBuffer()` 读到原始二进制，然后 `new Uint8Array(buffer)` 变成字节数组 `raw`

**2）在二进制里“抠出”编码串（通常是 Base64 文本）**
- `extractBinaryFormatterString(raw)`：[app.js:L51-L75](file:///d:/Projects/TraeProjects/parse/src/app.js#L51-L75)
- 做法是：
  - 从头扫描字节，找到 token `0x06`（你这里当作 BinaryFormatter 的 string 标记）：[app.js:L1](file:///d:/Projects/TraeProjects/parse/src/app.js#L1)
  - 计算 `strlenOffset = i + 5`，从这个位置开始读取“7-bit 变长整数”作为字符串长度：`read7bitEncodedInt`：[app.js:L26-L38](file:///d:/Projects/TraeProjects/parse/src/app.js#L26-L38)
  - 按长度切出那段 UTF-8 字节，再 `TextDecoder("utf-8")` 解码成 JS 字符串 `decoded`（这就是你要的“编码串”）：[app.js:L61-L65](file:///d:/Projects/TraeProjects/parse/src/app.js#L61-L65)
- 同时它还保存了 `header` 和 `footer`，用于后面导出时保持文件其它结构不变：[app.js:L65-L71](file:///d:/Projects/TraeProjects/parse/src/app.js#L65-L71)

**3）把“编码串”解密成 JSON 文本**
- 先从界面读取当前配置（算法、key、编码方式）：`getCryptoConfig()`：[app.js:L77-L82](file:///d:/Projects/TraeProjects/parse/src/app.js#L77-L82)
- `decryptText(extracted.encoded, cfg)`：[app.js:L141-L160](file:///d:/Projects/TraeProjects/parse/src/app.js#L141-L160)
  - 如果你选的是 AES-ECB/Pkcs7：
    - 先把 Base64/Hex/Base64URL 文本还原成“密文字节”（CryptoJS 的 WordArray）：`parseCiphertextToWordArray`：[app.js:L92-L97](file:///d:/Projects/TraeProjects/parse/src/app.js#L92-L97)
    - 再用 `CryptoJS.AES.decrypt` + `ECB` + `Pkcs7` + key 解出 UTF-8 明文字符串：[app.js:L150-L158](file:///d:/Projects/TraeProjects/parse/src/app.js#L150-L158)
  - 解密出来的结果在这里被命名为 `jsonText`：[app.js:L266-L268](file:///d:/Projects/TraeProjects/parse/src/app.js#L266-L268)

**4）把 JSON 文本变成“可编辑、格式化”的 JSON**
- 这里严格来说分两步：
  - `JSON.parse(jsonText)` 验证它确实是合法 JSON
  - `JSON.stringify(obj, null, 2)` 变成带缩进的漂亮格式
- 你代码里封装成了 `tryPrettyJson(text)`：[app.js:L190-L193](file:///d:/Projects/TraeProjects/parse/src/app.js#L190-L193)
- 最后把格式化后的 JSON 放进右侧文本框 `datJson`：[app.js:L268](file:///d:/Projects/TraeProjects/parse/src/app.js#L268)

一句话总结：  
**`.dat` 里藏着“加密后的编码字符串” → 先按 BinaryFormatter 结构把字符串取出来 → 按你选的编码（Base64/Hex）还原密文 → 用 AES+key 解密得到 JSON 字符串 → JSON.parse 成对象并格式化显示。**